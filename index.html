<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>MyDictionary â€” ç”¨èªé›†</title>
  <style>
    body{font-family: "Hiragino Kaku Gothic Pro","Helvetica",sans-serif; margin:20px;}
    header{display:flex;align-items:center;gap:20px;}
    .container{max-width:1000px;margin:20px auto;}
    .controls{display:flex;gap:8px;margin-bottom:16px;}
    input, textarea{padding:8px;border:1px solid #ccc;border-radius:4px;}
    button{padding:8px 12px;border-radius:6px;border:1px solid #888;background:#f5f5f5;cursor:pointer;}
    .row-title{font-size:1.2em;margin-top:24px;border-bottom:1px solid #ddd;padding-bottom:6px;}
    .term{padding:8px; border:1px solid #eee;border-radius:6px;margin:8px 0;display:flex;gap:12px;}
    .thumb{width:100px;height:80px;object-fit:cover;border-radius:4px;border:1px solid #ddd;}
    .meta{flex:1;}
    .word{font-weight:700;font-size:1.05em;}
    .description{white-space:pre-wrap;margin-top:6px;color:#333;}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“š MyDictionary â€” ç”¨èªé›†</h1>
      <div>
        <small>äº”åéŸ³ã§çœºã‚ã‚‹å½¢å¼ã€‚èª­ã¿(ã‹ãª)ã‚’å…¥åŠ›ã™ã‚‹ã¨ç²¾å¯†ã«ä¸¦ã³ã¾ã™ã€‚</small>
      </div>
    </header>

    <section style="margin-top:12px">
      <h2>ç”¨èªã‚’è¿½åŠ </h2>
      <div class="controls">
        <input id="word" placeholder="ç”¨èª (ä¾‹: Apple)" />
        <input id="reading" placeholder="èª­ã¿ï¼ˆã‹ãªãƒ»ä»»æ„ã€ä¾‹: ã‚Šã‚“ã”ï¼‰" />
        <input id="image_url" placeholder="ç”»åƒURLï¼ˆä»»æ„ï¼‰" />
      </div>
      <div style="margin-top:8px">
        <textarea id="description" placeholder="èª¬æ˜æ–‡ï¼ˆè¤‡æ•°è¡Œå¯ï¼‰" rows="4" style="width:100%"></textarea>
      </div>
      <div style="margin-top:8px">
        <button onclick="addTerm()">è¿½åŠ ã™ã‚‹</button>
        <span id="add-result" style="margin-left:12px;color:green"></span>
      </div>
    </section>

    <hr/>

    <section>
      <h2>ç”¨èªä¸€è¦§</h2>
      <p>â€» èª­ã¿ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯èª­ã¿ã‚’å„ªå…ˆã—ã¦ä¸¦ã¹ã¾ã™ã€‚è‡ªå‹•èª­ã¿ã¯ä»Šæœªå®Ÿè£…ã®ãŸã‚ã€æ‰‹å…¥åŠ›ã‚’æ¨å¥¨ã—ã¾ã™ã€‚</p>
      <div id="list"></div>
    </section>
  </div>

<script>
// äº”åéŸ³ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã®å…ˆé ­ï¼‰
const kanaGroups = ["ã‚","ã‹","ã•","ãŸ","ãª","ã¯","ã¾","ã‚„","ã‚‰","ã‚","ãã®ä»–"];

// å…ˆé ­æ–‡å­—ã‚’å–ã‚Šå‡ºã™ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
function firstChar(text){
  if(!text) return "";
  return text.trim().charAt(0);
}

// ã‚°ãƒ«ãƒ¼ãƒ—åˆ¤å®šï¼ˆç°¡æ˜“: å…ˆé ­ã®ã‹ãªã®å…ˆé ­æ–‡å­—ã§åˆ¤å®šï¼‰
function groupKey(ch){
  if(!ch) return "ãã®ä»–";
  const a = "ã‚ã„ã†ãˆãŠ";
  const ka = "ã‹ããã‘ã“";
  const sa = "ã•ã—ã™ã›ã";
  const ta = "ãŸã¡ã¤ã¦ã¨";
  const na = "ãªã«ã¬ã­ã®";
  const ha = "ã¯ã²ãµã¸ã»";
  const ma = "ã¾ã¿ã‚€ã‚ã‚‚";
  const ya = "ã‚„ã‚†ã‚ˆ";
  const ra = "ã‚‰ã‚Šã‚‹ã‚Œã‚";
  const wa = "ã‚ã‚’ã‚“";
  if(a.includes(ch)) return "ã‚";
  if(ka.includes(ch)) return "ã‹";
  if(sa.includes(ch)) return "ã•";
  if(ta.includes(ch)) return "ãŸ";
  if(na.includes(ch)) return "ãª";
  if(ha.includes(ch)) return "ã¯";
  if(ma.includes(ch)) return "ã¾";
  if(ya.includes(ch)) return "ã‚„";
  if(ra.includes(ch)) return "ã‚‰";
  if(wa.includes(ch)) return "ã‚";
  return "ãã®ä»–";
}

async function loadTerms(){
  const res = await fetch('/terms');
  const terms = await res.json();
  renderTerms(terms);
}

// æç”»: ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦è¡¨ç¤º
function renderTerms(terms){
  // terms ã¯æ—¢ã«ã‚µãƒ¼ãƒå´ã§ã‚½ãƒ¼ãƒˆã—ã¦ã„ã‚‹æƒ³å®šï¼ˆreadingå„ªå…ˆï¼‰
  const groups = {};
  kanaGroups.forEach(k => groups[k] = []);
  groups["ãã®ä»–"] = [];
  terms.forEach(t => {
    // ä½¿ã†æ–‡å­—ã¯ã€reading ã®å…ˆé ­ï¼ˆå­˜åœ¨ã™ã‚Œã°ï¼‰ãã‚Œä»¥å¤–ã¯ word ã®å…ˆé ­
    const source = (t.reading && t.reading.trim()) ? t.reading.trim() : t.word.trim();
    const ch = firstChar(source);
    const key = groupKey(ch);
    groups[key].push(t);
  });

  // DOM ã«æç”»
  const container = document.getElementById('list');
  container.innerHTML = '';
  for(const k of kanaGroups){
    const items = groups[k] || [];
    if(items.length === 0) continue;
    const section = document.createElement('div');
    const title = document.createElement('div');
    title.className = 'row-title';
    title.textContent = k + " è¡Œ";
    section.appendChild(title);
    items.forEach(t => {
      const el = document.createElement('div');
      el.className = 'term';
      const imgWrap = document.createElement('div');
      if(t.image_url){
        const img = document.createElement('img');
        img.src = t.image_url;
        img.className = 'thumb';
        imgWrap.appendChild(img);
      }
      const meta = document.createElement('div');
      meta.className = 'meta';
      const w = document.createElement('div');
      w.className = 'word';
      w.textContent = t.word + (t.reading ? ("ï¼ˆ" + t.reading + "ï¼‰") : "");
      const d = document.createElement('div');
      d.className = 'description';
      d.textContent = t.description;
      meta.appendChild(w);
      meta.appendChild(d);
      el.appendChild(imgWrap);
      el.appendChild(meta);
      section.appendChild(el);
    });
    container.appendChild(section);
  }
}

// è¿½åŠ å‡¦ç†ï¼ˆJSON POSTï¼‰
async function addTerm(){
  const word = document.getElementById('word').value.trim();
  const reading = document.getElementById('reading').value.trim();
  const image_url = document.getElementById('image_url').value.trim();
  const description = document.getElementById('description').value.trim();
  if(!word || !description){
    alert("ç”¨èªã¨èª¬æ˜æ–‡ã¯å¿…é ˆã§ã™ã€‚");
    return;
  }
  const payload = { word, reading: reading || null, image_url: image_url || null, description };
  const res = await fetch('/add_term', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(res.ok){
    document.getElementById('add-result').textContent = data.message;
    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç©ºã«ã—ã¦ä¸€è¦§ã‚’å†å–å¾—
    document.getElementById('word').value = '';
    document.getElementById('reading').value = '';
    document.getElementById('image_url').value = '';
    document.getElementById('description').value = '';
    setTimeout(()=> document.getElementById('add-result').textContent = '', 3000);
    await loadTerms();
  } else {
    alert(data.detail || data.message || "è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ");
  }
}

// åˆå›ãƒ­ãƒ¼ãƒ‰
loadTerms();
</script>
</body>
</html>
